<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>c | 异常处理</title>
    <meta name="description" content="less is more">
    <link rel="icon" href="/logo.jpg">
  <link rel="stylesheet" href="/reset.css">
  <script src="/canvas.js" defer="defer"></script>
    
    <link rel="preload" href="/assets/css/0.styles.7cff02b1.css" as="style"><link rel="preload" href="/assets/js/app.e3ce4d4b.js" as="script"><link rel="preload" href="/assets/js/10.02711b23.js" as="script"><link rel="prefetch" href="/assets/js/1.0371fcdf.js"><link rel="prefetch" href="/assets/js/2.23685ec5.js"><link rel="prefetch" href="/assets/js/3.7c83f47a.js"><link rel="prefetch" href="/assets/js/4.1de3d39c.js"><link rel="prefetch" href="/assets/js/5.a7678d2b.js"><link rel="prefetch" href="/assets/js/6.bf9b4a6d.js"><link rel="prefetch" href="/assets/js/7.d8bd438b.js"><link rel="prefetch" href="/assets/js/8.fd41b3f7.js"><link rel="prefetch" href="/assets/js/9.8367976f.js"><link rel="prefetch" href="/assets/js/11.ece1be8d.js"><link rel="prefetch" href="/assets/js/12.98d096d7.js"><link rel="prefetch" href="/assets/js/13.7ef57a8f.js"><link rel="prefetch" href="/assets/js/14.3b7ec7cf.js"><link rel="prefetch" href="/assets/js/15.d4f0b9c3.js"><link rel="prefetch" href="/assets/js/16.9f1e6fb6.js"><link rel="prefetch" href="/assets/js/17.c09a3e0b.js"><link rel="prefetch" href="/assets/js/18.2834129e.js"><link rel="prefetch" href="/assets/js/19.dc8c4ec9.js">
    <link rel="stylesheet" href="/assets/css/0.styles.7cff02b1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/" class="home-link router-link-active"><!----><span class="site-name">
      c
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/notes/" class="nav-link router-link-active">笔记</a></div><!----></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/notes/" class="nav-link router-link-active">笔记</a></div><!----></nav><ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>异常处理</span><!----></p><ul class="sidebar-group-items"><li><a href="/notes/error.html#异常捕获" class="sidebar-link">异常捕获</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes/error.html#try-catch-finally" class="sidebar-link">try-catch-finally</a></li><li class="sidebar-sub-header"><a href="/notes/error.html#window-onerror" class="sidebar-link">window.onerror</a></li><li class="sidebar-sub-header"><a href="/notes/error.html#promise-prototype-catch" class="sidebar-link">Promise.prototype.catch()</a></li><li class="sidebar-sub-header"><a href="/notes/error.html#window-addeventlistener" class="sidebar-link">window.addEventListener</a></li><li class="sidebar-sub-header"><a href="/notes/error.html#vue-config-errorhandler" class="sidebar-link">Vue.config.errorHandler</a></li><li class="sidebar-sub-header"><a href="/notes/error.html#react错误边界" class="sidebar-link">React错误边界</a></li></ul></li><li><a href="/notes/error.html#异常场景" class="sidebar-link">异常场景</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes/error.html#代码运行异常" class="sidebar-link">代码运行异常</a></li><li class="sidebar-sub-header"><a href="/notes/error.html#语法错误" class="sidebar-link">语法错误</a></li><li class="sidebar-sub-header"><a href="/notes/error.html#promise异常" class="sidebar-link">Promise异常</a></li><li class="sidebar-sub-header"><a href="/notes/error.html#静态资源加载异常" class="sidebar-link">静态资源加载异常</a></li><li class="sidebar-sub-header"><a href="/notes/error.html#react异常及降级ui" class="sidebar-link">React异常及降级UI</a></li><li class="sidebar-sub-header"><a href="/notes/error.html#异常上报" class="sidebar-link">异常上报</a></li></ul></li><li><a href="/notes/error.html#处理规范" class="sidebar-link">处理规范</a><ul class="sidebar-sub-headers"></ul></li></ul></div></li></ul></div><div class="page"><div class="content"><h1 id="异常处理"><a href="#异常处理" aria-hidden="true" class="header-anchor">#</a> 异常处理</h1><h2 id="异常捕获"><a href="#异常捕获" aria-hidden="true" class="header-anchor">#</a> 异常捕获</h2><h3 id="try-catch-finally"><a href="#try-catch-finally" aria-hidden="true" class="header-anchor">#</a> try-catch-finally</h3><pre class="language-javascript"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// todo</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 捕获 todo 异常</span>
<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    <span class="token comment">// 无论是否有异常都将进入</span>
<span class="token punctuation">}</span>
</code></pre><p><code>try...catch</code> 语句标记一块待尝试的语句，并规定一个以上的响应应该有一个异常被抛出。如果代码抛出一个异常，<code>try...catch</code> 语句就捕获它。如果 <code>try</code> 代码块没有异常，则不会流转到 <code>catch</code> 代码块，<code>finally</code> 代码块总会紧跟在 <code>try</code> 和 <code>catch</code> 代码块之后执行，但会在 <code>try</code> 和 <code>catch</code> 代码块之后的其他代码之前执行，有几个地方需要注意：</p><ol><li>无法捕获异步的异常</li><li>只能捕获同步代码运行时的错误，无法捕获异步及语法错误</li><li><code>try</code> 代码块不能单独存在，至少跟随 <code>catch</code> 或 <code>finally</code> 代码块</li></ol><h3 id="window-onerror"><a href="#window-onerror" aria-hidden="true" class="header-anchor">#</a> window.onerror</h3><pre class="language-javascript"><code><span class="token comment">/**
* @param {String} message 错误信息
* @param {String} source  发生错误的脚本URL
* @param {Number} lineno  发生错误的行号
* @param {Number} colno   发生错误的列号
* @param {Error } error   Error对象
*/</span>
window<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token punctuation">(</span>message<span class="token punctuation">,</span> source<span class="token punctuation">,</span> lineno<span class="token punctuation">,</span> colno<span class="token punctuation">,</span> error<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// todo</span>
<span class="token punctuation">}</span>
</code></pre><p>当JavaScript运行时错误（包括语法错误）发生时，<code>window</code>会触发一个<code>ErrorEvent</code>接口的<code>error</code>事件，并执行<code>window.onerror()</code>，但是无法捕获到静态资源（如图片或js脚本）加载的异常</p><h3 id="promise-prototype-catch"><a href="#promise-prototype-catch" aria-hidden="true" class="header-anchor">#</a> Promise.prototype.catch()</h3><pre class="language-javascript"><code><span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
promise<span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// todo</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><code>Promise.prototype.catch()</code> 是<code>.then(null, rejection)</code>或<code>.then(undefined, rejection)</code>的别名，用于指定发生错误时的回调函数。</p><h3 id="window-addeventlistener"><a href="#window-addeventlistener" aria-hidden="true" class="header-anchor">#</a> window.addEventListener</h3><h4 id="error事件"><a href="#error事件" aria-hidden="true" class="header-anchor">#</a> error事件</h4><pre class="language-javascript"><code>document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// todo</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
</code></pre><p>与 <code>window.onerror</code> 相似，不过回调函数只接收一个值，包含了 <code>onerror</code> 回调的所有参数，并且可以捕获静态资源加载的异常</p><h4 id="unhandledrejection事件"><a href="#unhandledrejection事件" aria-hidden="true" class="header-anchor">#</a> unhandledrejection事件</h4><pre class="language-javascript"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;unhandledrejection&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// todo</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><p>用于 <code>Promise</code> 实例未指定 <code>catch</code> 方法时，收集 <code>Promise</code> 的异常</p><h3 id="vue-config-errorhandler"><a href="#vue-config-errorhandler" aria-hidden="true" class="header-anchor">#</a> Vue.config.errorHandler</h3><pre class="language-javascript"><code><span class="token comment">/**
* handle error
* info 是 Vue 特定的错误信息，比如错误所在的生命周期钩子
* 只在 2.2.0+ 可用
*/</span>
Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token function-variable function">errorHandler</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// todo</span>
<span class="token punctuation">}</span>
</code></pre><p>指定组件的渲染和观察期间未捕获错误的处理函数。这个处理函数被调用时，可获取错误信息和 <code>Vue</code> 实例。</p><h3 id="react错误边界"><a href="#react错误边界" aria-hidden="true" class="header-anchor">#</a> React错误边界</h3><p><code>React 16</code> 提供了一个内置函数 <code>componentDidCatch</code>，使用它可以非常简单的获取到 <code>react</code> 下的错误信息，注意，错误边界无法捕获以下场景中产生的错误：</p><ol><li>事件处理</li><li>异步代码</li><li>服务端渲染</li><li>自身抛出来的错误（并非它的子组件）</li></ol><pre class="language-jsx"><code><span class="token keyword">class</span> <span class="token class-name">ErrorBoundary</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">componentDidCatch</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// todo</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h2 id="异常场景"><a href="#异常场景" aria-hidden="true" class="header-anchor">#</a> 异常场景</h2><h3 id="代码运行异常"><a href="#代码运行异常" aria-hidden="true" class="header-anchor">#</a> 代码运行异常</h3><h4 id="同步异常"><a href="#同步异常" aria-hidden="true" class="header-anchor">#</a> 同步异常</h4><pre class="language-javascript"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
    undefined<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token comment">// TypeError: Cannot read property 'map' of undefined</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="异步异常"><a href="#异步异常" aria-hidden="true" class="header-anchor">#</a> 异步异常</h4><pre class="language-javascript"><code>window<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token punctuation">(</span> message<span class="token punctuation">,</span> source<span class="token punctuation">,</span> lineno<span class="token punctuation">,</span> colno<span class="token punctuation">,</span> error <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> message<span class="token punctuation">,</span> source<span class="token punctuation">,</span> lineno<span class="token punctuation">,</span> colno<span class="token punctuation">,</span> error <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// { message: &quot;Uncaught TypeError: Cannot read property 'map' of undefined&quot;, source: &quot;file:///E:/inde... }</span>
<span class="token punctuation">}</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    undefined<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>
</code></pre><h3 id="语法错误"><a href="#语法错误" aria-hidden="true" class="header-anchor">#</a> 语法错误</h3><p>语法相关的异常，当Javascript语言解析代码时，Javascript引擎将会发现不符合语法规范的代码，并抛出SyntaxError错误。</p><h3 id="promise异常"><a href="#promise异常" aria-hidden="true" class="header-anchor">#</a> Promise异常</h3><h4 id="有catch方法"><a href="#有catch方法" aria-hidden="true" class="header-anchor">#</a> 有catch方法</h4><pre class="language-javascript"><code><span class="token keyword">let</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    undefined<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>err <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token comment">// TypeError: Cannot read property 'map' of undefined</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><h4 id="无catch方法"><a href="#无catch方法" aria-hidden="true" class="header-anchor">#</a> 无catch方法</h4><pre class="language-javascript"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;unhandledrejection&quot;</span><span class="token punctuation">,</span> e <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
    <span class="token comment">// PromiseRejectionEvent {isTrusted: true, promise: Promise, reason: TypeError: Cannot read property 'map' of undefined at …, type: &quot;unhandledrejection&quot; …}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    undefined<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><h3 id="静态资源加载异常"><a href="#静态资源加载异常" aria-hidden="true" class="header-anchor">#</a> 静态资源加载异常</h3><p>例如当样式表加载异常时</p><pre class="language-html"><code><span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>ie=edge<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>stylesheet<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>https://test.com/test.css<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript">
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token comment">//Event {isTrusted: true, type: &quot;error&quot;, target: link, currentTarget: Window, eventPhase: 1, …}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre><h3 id="react异常及降级ui"><a href="#react异常及降级ui" aria-hidden="true" class="header-anchor">#</a> React异常及降级UI</h3><p>当componentDidCatch抛出错误后，请使用 static getDerivedStateFromError() 渲染备用 UI</p><pre class="language-jsx"><code><span class="token keyword">class</span> <span class="token class-name">ErrorBoundary</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> hasError<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">getDerivedStateFromError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 更新 state 使下一次渲染能够显示降级后的 UI</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> hasError<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">componentDidCatch</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>hasError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 你可以自定义降级后的 UI 并渲染</span>
      <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">Something went wrong.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>作为组件使用</p><pre class="language-jsx"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ErrorBoundary</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MyWidget</span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ErrorBoundary</span><span class="token punctuation">&gt;</span></span>
</code></pre><h3 id="异常上报"><a href="#异常上报" aria-hidden="true" class="header-anchor">#</a> 异常上报</h3><p>异常上报可以通过 ajax 调用接口，但是可能存在跨域等问题，推荐使用动态创建 img 标签</p><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">ErrorReporter</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">=</span> url
    <span class="token punctuation">}</span>
    <span class="token function">send</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?error=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>error<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> errorReporter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorReporter</span><span class="token punctuation">(</span><span class="token string">&quot;http://test&quot;</span><span class="token punctuation">)</span>
errorReporter<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token comment">/*error*/</span><span class="token punctuation">)</span>
</code></pre><h2 id="处理规范"><a href="#处理规范" aria-hidden="true" class="header-anchor">#</a> 处理规范</h2><ol><li>非稳定同步代码块增加 <code>try-catch</code>，<code>catch</code> 时请分清稳定代码和非稳定代码，稳定代码指的是无论如何不会出错的代码。对于非稳定代码的 <code>catch</code> 尽可能进行区分异常类型，再做对应的异常处理</li><li>异常不要用来做流程控制和条件控制</li><li>捕获异常是为了处理它，不要捕获了却什么都不处理而抛弃之，如果不想处理它，请将该异常抛给它的调用者。最外层的业务使用者，必须处理异常，将其转化为用户可以理解的内容</li><li>全局监控js异常，并且不要忽略异步异常，使用 <code>window.onerror</code></li><li>监听全局静态资源加载异常使用 <code>addEventListener</code> 监听 <code>error</code> 事件，处理异常判断是否是静态资源异常，与 <code>window.onerror</code> 做区分</li><li>监听全局未 <code>catch</code> 的 <code>Promise</code> 对象用 <code>addEventListener</code> 监听 <code>unhandledrejection</code> 事件</li><li><code>React</code> 异常使用 <code>componentDidCatch</code> (React 16以上)</li><li><code>Vue</code> 异常使用 <code>Vue.config.errorHandler</code></li></ol></div><!----><!----></div></div></div>
    <script src="/assets/js/10.02711b23.js" defer></script><script src="/assets/js/app.e3ce4d4b.js" defer></script>
  </body>
</html>
